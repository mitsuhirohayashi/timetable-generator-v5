# アーキテクチャ図 - リファクタリング前後の比較

## 現在のアーキテクチャ（問題あり）

```
┌─────────────────────────────────────────────────────────────┐
│                        ROOT (114 files!)                      │
│  main.py, test_*.py, fix_*.py, analyze_*.py, debug_*.py... │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                           src/                               │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────┐  ┌─────────────────┐                   │
│ │  presentation/  │  │  application/   │                   │
│ │   (5 files)     │◄─┤   (24 files)    │◄┐                 │
│ └─────────────────┘  └─────────────────┘  │ 🚫 違反！      │
│                                            │                 │
│ ┌─────────────────────────────────────────┴───┐             │
│ │              domain/ (158 files!)            │             │
│ │  - services/ (110+ files) ← 多すぎる！      │             │
│ │  - constraints/ (18 files)                  │             │
│ │  - entities/ (10 files)                     │             │
│ └──────────────────────────────────────────────┘             │
│                       ▲                                      │
│                       │ 🚫 逆依存！                          │
│ ┌─────────────────────┴─────────────────────┐               │
│ │        infrastructure/ (56 files)         │               │
│ └───────────────────────────────────────────┘               │
└─────────────────────────────────────────────────────────────┘

問題点:
- ❌ ルートディレクトリに114個のPythonファイル
- ❌ ドメイン層に110個以上のサービス（ビジネスロジック混在）
- ❌ アプリケーション層が基盤層に直接依存
- ❌ レイヤー間の境界が不明確
```

## リファクタリング後のアーキテクチャ（理想）

```
┌─────────────────────────────────────────────────────────────┐
│                     ROOT (2 files only)                      │
│                    main.py, setup.py                         │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                           src/                               │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────┐                                        │
│ │  presentation/  │  依存性注入                             │
│ │   - cli/        ├──────────┐                             │
│ │   - api/        │          ▼                             │
│ └─────────────────┘  ┌─────────────────┐                   │
│                      │  application/   │                   │
│                      │   - services/   │                   │
│                      │   - use_cases/  │                   │
│                      │   - dto/        │                   │
│                      └────────┬────────┘                   │
│                               │ インターフェース経由        │
│                               ▼                             │
│                      ┌─────────────────┐                   │
│                      │     domain/     │                   │
│                      │   - entities/   │                   │
│                      │   - values/     │                   │
│                      │   - interfaces/ │                   │
│                      │   - services/   │                   │
│                      └────────┬────────┘                   │
│                               │                             │
│                               ▼                             │
│                      ┌─────────────────┐                   │
│                      │ infrastructure/ │                   │
│                      │   - repos/      │                   │
│                      │   - config/     │                   │
│                      │   - external/   │                   │
│                      └─────────────────┘                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                         scripts/                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
│  │analysis/ │ │ fixes/   │ │ utils/   │ │ migrate/ │      │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                          tests/                              │
│  ┌──────────┐ ┌──────────────┐ ┌──────────┐                │
│  │  unit/   │ │ integration/ │ │   e2e/   │                │
│  └──────────┘ └──────────────┘ └──────────┘                │
└─────────────────────────────────────────────────────────────┘

改善点:
- ✅ ルートは最小限（2ファイルのみ）
- ✅ 明確なレイヤー分離
- ✅ インターフェース経由の依存
- ✅ 各レイヤーの責務が明確
- ✅ テストが種類別に整理
```

## サービス配置の詳細

### Before（現在）
```
src/domain/services/ (110+ files)
├── schedule_generator_v2.py
├── schedule_generator_v3.py
├── ... (v14まで)
├── csp_solver.py
├── optimizer.py
├── data_loader.py          ← アプリケーション層の責務
├── file_writer.py          ← インフラ層の責務
└── constraint_checker.py   ← ドメイン層で正しい
```

### After（リファクタリング後）
```
src/
├── domain/services/ (20 files)     # 純粋なドメインロジックのみ
│   ├── schedule_validator.py
│   ├── constraint_checker.py
│   ├── grade5_rules.py
│   └── exchange_class_rules.py
│
├── application/services/ (40 files) # ビジネスロジック
│   ├── schedule_generation/
│   │   ├── generator_factory.py
│   │   ├── generation_pipeline.py
│   │   └── strategies/
│   ├── optimization/
│   │   ├── optimizer_factory.py
│   │   └── optimization_strategies/
│   └── data_processing/
│
└── infrastructure/adapters/ (30 files) # 外部システムとの接続
    ├── file_system/
    ├── database/
    └── external_api/
```

## プラグインアーキテクチャ（Phase 4）

```
┌─────────────────────────────────────────────────────────────┐
│                     Plugin System                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐   │
│  │ Constraint  │    │ Generator   │    │ Optimizer   │   │
│  │  Plugins    │    │  Plugins    │    │  Plugins    │   │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘   │
│         │                   │                   │           │
│         └───────────────────┴───────────────────┘           │
│                             │                               │
│                    ┌────────▼────────┐                      │
│                    │  Plugin Loader  │                      │
│                    └────────┬────────┘                      │
│                             │                               │
│                    ┌────────▼────────┐                      │
│                    │   Core System   │                      │
│                    └─────────────────┘                      │
└─────────────────────────────────────────────────────────────┘

利点:
- 新しい制約の追加が容易
- コアシステムの変更不要
- 動的なプラグインロード
- 設定による有効/無効の切り替え
```