# ハードコードされたビジネスルールの移行ガイド

## 概要
コードベース内にハードコードされているビジネスルールをQA.txtに移行すべき箇所を特定しました。
これらのルールを外部化することで、コード変更なしにビジネスルールを更新できるようになります。

## 既にQA.txtに移行されているルール（参考）

`src/infrastructure/config/qa_rules_loader.py`が以下のルールを読み込んでいます：
- 担任教師のマッピング
- 非常勤教師の勤務時間
- 定例会議の情報
- 教師の役職
- 定期的な不在
- 6限目のルール
- 標準授業時数
- 科目の優先順位
- 5組の好み
- 教師の配分比率

## 移行すべきハードコードされたルール

### 1. domain/constants.py - 基本的な学校構造データ

```python
# 5組のクラスリスト
_DEFAULT_GRADE5_CLASSES = ["1年5組", "2年5組", "3年5組"]

# 自立活動関連の科目
_DEFAULT_JIRITSU_SUBJECTS = ["自立", "日生", "生単", "作業"]
_DEFAULT_JIRITSU_PARENT_SUBJECTS = ["数", "英"]

# 固定科目のリスト
_DEFAULT_FIXED_SUBJECTS = [
    "欠", "YT", "学", "学活", "総", "総合", "道", "道徳", 
    "学総", "行", "行事", "テスト", "技家"
]

# 会議の種類とデフォルト時間
_DEFAULT_MEETING_TYPES = ["HF", "企画", "特会", "生指"]
_DEFAULT_MEETINGS = {
    "HF": ("火", 4),
    "企画": ("火", 3),
    "特会": ("水", 2),
    "生指": ("木", 3)
}

# 教科のカテゴリ分類
_DEFAULT_CORE_SUBJECTS = ["国", "数", "英", "理", "社"]
_DEFAULT_SPECIAL_SUBJECTS = ["音", "美", "技", "家", "体"]
_DEFAULT_OTHER_SUBJECTS = ["道", "総", "学"]

# 交流学級と親学級のペア
_DEFAULT_EXCHANGE_CLASS_PAIRS = {
    "1年6組": "1年1組",
    "1年7組": "1年2組",
    "2年6組": "2年3組",
    "2年7組": "2年2組",
    "3年6組": "3年3組",
    "3年7組": "3年2組"
}

# 標準授業時数
_DEFAULT_STANDARD_HOURS = {
    "国": 4, "数": 3, "英": 4, "理": 3, "社": 3,
    "音": 1, "美": 1, "体": 3, "技": 1, "家": 1,
    "道": 1, "総": 2, "学": 1
}
```

**移行理由**: これらは学校の基本構造であり、学校ごとに異なる可能性があるため外部化すべきです。

### 2. monday_sixth_period_constraint.py - 月曜6限の特別ルール

```python
# 3年生の通常学級（3-1, 3-2, 3-3）は制約を適用しない
if assignment.class_ref.grade == 3 and assignment.class_ref.is_regular_class():
    return True
# それ以外のクラス（1-2年生全クラス、5組、交流学級）は欠課のみ許可
return assignment.subject.name == '欠'
```

**移行理由**: 学年ごとの6限目ルールは変更される可能性があります。

### 3. learned_rule_constraint.py - 井上先生の特別ルール

```python
# 井上先生の火曜5限の特別チェック
if assignment.teacher.name == "井上" and time_slot.day == "火" and time_slot.period == 5:
    # デバッグログ出力...
```

**移行理由**: 特定の教師への特別ルールはQA.txtで管理すべきです。

### 4. smart_empty_slot_filler.py - 空きスロット埋めの優先順位

```python
# 水曜4限を最優先で処理
wed4_slot = TimeSlot("水", 4)

# 3年生の6限は優先度を高くする
elif class_ref.grade == 3 and period == 6 and day in ["月", "火", "水"]:
    priority_slots.append((time_slot, class_ref))

# 1・2年生のルール
# 月曜6限（欠）- 全学年共通だが3年生は例外
if time_slot.day == "月" and time_slot.period == 6:
    return True

# 1・2年生は火曜・水曜・金曜の6限をスキップ（YT）
if ((time_slot.day == "火" and time_slot.period == 6) or
    (time_slot.day == "水" and time_slot.period == 6) or
    (time_slot.day == "金" and time_slot.period == 6)):
    return True
```

**移行理由**: 学年別の6限目ルールと優先順位は頻繁に変更される可能性があります。

## 推奨されるQA.txtの構造

```
📌 恒久的ルール（常に適用）

### 学校基本構造
- 5組クラス: 1年5組, 2年5組, 3年5組
- 交流学級ペア:
  - 1年6組 ← 1年1組
  - 1年7組 ← 1年2組
  - 2年6組 ← 2年3組
  - 2年7組 ← 2年2組
  - 3年6組 ← 3年3組
  - 3年7組 ← 3年2組

### 固定科目
- 変更不可科目: 欠, YT, 学, 学活, 総, 総合, 道, 道徳, 学総, 行, 行事, テスト, 技家
- 自立活動科目: 自立, 日生, 生単, 作業
- 自立活動時の親学級科目: 数, 英

### 標準授業時数（週あたり）
- 主要5教科: 国(4), 数(3), 英(4), 理(3), 社(3)
- 実技教科: 音(1), 美(1), 体(3), 技(1), 家(1)
- その他: 道(1), 総(2), 学(1)

### 6限目ルール
- 1・2年生:
  - 月曜6限: 欠
  - 火曜6限: YT
  - 水曜6限: YT
  - 金曜6限: YT
- 3年生:
  - 月曜6限: 通常授業可能
  - 火曜6限: 通常授業可能
  - 水曜6限: 通常授業可能
  - 金曜6限: YT

### 優先配置ルール
- 5組の水曜4限を最優先で埋める
- 3年生の月火水6限を優先的に埋める
- 空きスロット埋めの科目優先順位: 国, 数, 英, 理, 社, 音, 美, 体, 技, 家
```

## 実装方法

1. `qa_rules_loader.py`に新しい抽出メソッドを追加
2. ハードコードされた値を設定から読み込むように変更
3. デフォルト値は現在の値を使用（互換性維持）
4. 段階的に移行し、各段階でテストを実施

## 優先順位

1. **高優先度**: 学年別6限目ルール、優先配置ルール
2. **中優先度**: 標準授業時数、教科カテゴリ
3. **低優先度**: 基本構造データ（変更頻度が低い）

## まとめ

これらのルールをQA.txtに移行することで：
- ビジネスルールの変更が容易になる
- コードの保守性が向上する
- 学校ごとのカスタマイズが可能になる
- ルールの一元管理が実現する