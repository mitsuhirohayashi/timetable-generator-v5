# ハードコードルールのQA.txt移行 - 最終レポート

## 実施日時
2025-06-21

## 実施内容サマリー

時間割生成システム内にハードコードされていたビジネスルールを、すべてQA.txtに移行し、QARulesLoaderを通じて動的に読み込むシステムに変更しました。

## 移行完了項目

### 1. QA.txtへの追加ルール

#### 教師関連
- **各クラスの担任教師**: 18クラス分の担任マッピング
- **非常勤教師の勤務時間**: 青井先生の勤務可能時間
- **教師の役職**: 企画委員、学年主任などの役職情報
- **定期的な教師不在**: 毎週の終日不在パターン

#### 会議関連
- **定例会議の詳細**: 企画、HF、特会、生指の時間と参加者

#### 授業配置ルール
- **6限目の学年別詳細ルール**: 3年生の特別扱いを含む
- **標準授業時数**: 全教科の週あたり標準時数
- **教科配置の優先順位**: 主要教科優先の明文化
- **5組の特別ルール**: 教師比率、優先教師の設定
- **技家の担当教師**: 林先生と金子み先生の両方

### 2. コード修正

#### 制約クラス
- **PartTimeTeacherConstraint**: 青井先生のハードコードを削除、外部注入対応
- **MondaySixthPeriodConstraint**: 6限目ルールを外部注入対応

#### サービスクラス
- **SmartEmptySlotFiller**: 担任教師、6限目ルール、優先教科を外部注入対応
- **Grade5TeacherSelector**: 教師比率を外部注入対応
- **Grade5PriorityPlacementService**: 優先教師を外部注入対応
- **MeetingTimeOptimizer**: 会議設定、教師役職、定期不在を外部注入対応

#### インフラストラクチャ
- **ConstraintLoader**: QARulesLoaderを統合、ルールを各制約に注入
- **EmptySlotFiller**: QARulesLoaderのルールをSmartEmptySlotFillerに注入
- **ScheduleOptimizationUseCase**: QARulesLoaderのルールをMeetingTimeOptimizerに注入

### 3. 新規作成

#### QARulesLoader
場所: `src/infrastructure/config/qa_rules_loader.py`

機能:
- QA.txtからビジネスルールを読み込み
- 構造化されたデータとして各種ルールを提供
- 使いやすいアクセサメソッドを実装

主なメソッド:
- `get_homeroom_teacher()`: 担任教師を取得
- `get_part_time_slots()`: 非常勤教師の勤務可能時間を取得
- `get_meeting_info()`: 会議情報を取得
- `get_6th_period_rule()`: 6限目ルールを取得
- など

#### テスト
場所: `tests/test_qa_rules_loader.py`

内容:
- QARulesLoaderの単体テスト
- ルール読み込みの正確性を検証
- エラーハンドリングのテスト

## 効果

### 保守性の向上
- ルール変更時にコード修正不要
- 非技術者でもQA.txtを編集可能
- 年度更新時の作業簡素化

### 柔軟性の向上
- 学校ごとのカスタマイズが容易
- 実行時のルール変更が可能
- 新しいルールの追加が簡単

### 可視性の向上
- すべてのビジネスルールが一箇所に集約
- ルールの理由や背景が明確
- 新任者への引き継ぎが容易

## 今後の推奨事項

### 1. 運用ルール
- 新しいビジネスルールは必ずQA.txtに記載
- コード内にハードコードしない
- QARulesLoaderを通じて取得する

### 2. 拡張案
- QA.txtの自動検証機能
- ルール変更の履歴管理
- Web UIからのルール編集機能

### 3. 注意事項
- QA.txtのフォーマットを維持すること
- ルール追加時は日付を記載すること
- 重要度に応じてセクションを分けること

## 技術的な考慮事項

### Clean Architectureの維持
- ドメインレイヤーは外部設定に依存しない
- ルールは初期化時に注入される
- DIコンテナまたはファクトリーで管理

### パフォーマンス
- QA.txtは起動時に一度だけ読み込み
- メモリにキャッシュして高速アクセス
- 変更検知による自動リロード（将来実装）

## まとめ

この移行により、時間割生成システムは以下の特徴を持つようになりました：

1. **設定駆動型システム**: ビジネスルールがコードから分離
2. **高い保守性**: ルール変更が容易
3. **透明性**: すべてのルールが明文化
4. **拡張性**: 新しいルールの追加が簡単

システムの持続可能性が大幅に向上し、長期的な運用とメンテナンスが容易になりました。