# 制約違反の誤検出防止実装完了報告

## 実装日: 2025-06-22

## 概要
制約違反チェッカーが正常なパターンを違反として誤検出する問題を解決するため、除外ルールシステムを実装しました。

## 実装内容

### 1. 制約除外ルール設定ファイル
**ファイル**: `data/config/constraint_exclusion_rules.json`

以下の正常パターンを定義：
- **テスト期間の巡回監督**: 同一学年・同一科目での教師重複を許可
- **5組合同授業**: 1-5、2-5、3-5の3クラス同時授業を許可
- **交流学級と親学級の体育同時実施**: ペアでの体育館使用を許可
- **自立活動の教師重複**: 財津先生・智田先生の複数クラス担当を条件付きで許可
- **仮想教師の重複**: 欠課先生などの重複を除外

### 2. 教師重複制約の改善
**ファイル**: `src/domain/constraints/teacher_conflict_constraint.py`

改善内容：
- 除外ルールを読み込む機能を追加
- `_should_exclude_conflict`メソッドで正常パターンを判定
- テスト期間、5組合同授業、自立活動重複などを自動除外

### 3. 体育館使用制約
**ファイル**: `src/domain/constraints/gym_usage_constraint.py`

既に実装済みの機能：
- 交流学級ペアを`exchange_class_pairs.csv`から読み込み
- 親学級と交流学級の同時体育を正常として処理

### 4. 制約違反チェッカーの改善
**ファイル**: `scripts/analysis/check_violations.py`

改善内容：
- 除外ルールを読み込む機能を追加
- 正常パターンが除外されたことを通知
- より正確な違反数を表示

### 5. ドキュメント更新

#### CLAUDE.md
「制約違反の正常パターン」セクションを追加：
- 5つの正常パターンを詳細に説明
- システムの自動対応について記載

#### QA.txt
「恒久的ルール」セクションに追加：
- 制約違反の正常パターンを恒久ルールとして記載

## 現在の状況

### 解決された問題
1. ✅ テスト期間の教師巡回監督が違反として報告されない
2. ✅ 5組の合同授業での教師重複が正常として扱われる
3. ✅ 交流学級と親学級の体育同時実施が許可される
4. ✅ 財津先生・智田先生の自立活動重複が条件付きで許容される
5. ✅ 仮想教師（欠課先生など）の重複が除外される

### 残存する課題
現在の`output.csv`では教師名が含まれておらず、システムが自動的に「英担当先生」などの汎用名を使用しているため、実際に教師重複違反が発生しています。これは誤検出ではなく、実際の問題です。

解決方法：
1. 適切な教師配置データ（`teacher_subject_mapping.csv`）を用意する
2. 時間割生成時に実際の教師名を割り当てる

## 使用方法

制約違反をチェック：
```bash
python3 scripts/analysis/check_violations.py
```

除外ルールを編集：
```bash
# data/config/constraint_exclusion_rules.json を編集
```

## まとめ
制約違反の誤検出を防ぐシステムは正常に実装されました。現在報告されている違反は、教師データの不足による実際の問題であり、誤検出ではありません。