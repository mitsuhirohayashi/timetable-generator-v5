# QandA継続的改善システム ガイド

## 概要
このシステムは、ユーザーからのフィードバックやルールを自動的に学習し、時間割生成の品質を継続的に向上させます。

## 🎯 主要な改善点（2025-06-21）

### 1. QA.txtへのルール記録
- 空きスロット埋め時の交流学級同期ルールをQA.txtに移行
- 今後の新しいルールは全てQA.txtに記録
- CLAUDE.mdではなくQA.txtを真実の源泉（Single Source of Truth）として使用

### 2. 交流学級同期対応の空きスロット埋め
新しいスクリプト: `scripts/utilities/manual_fill_empty_slots_with_sync.py`

**特徴**:
- 交流学級と親学級の同期を自動的に維持
- 空きスロットを埋める際、ペアクラスも同時に処理
- 自立活動の時間は適切にスキップ
- QA.txtのルールに完全準拠

**使用方法**:
```bash
python3 scripts/utilities/manual_fill_empty_slots_with_sync.py
```

### 3. QandA学習機能の強化
新しいサービス: `src/application/services/qanda_learning_enhancement.py`

**機能**:
- ユーザーフィードバックを自動分析
- 新しいルールをQA.txtに自動追加
- 制約違反からルールを自動抽出
- 改善提案を自動生成

## 🔄 継続的改善のワークフロー

### 1. ルールの追加プロセス
```
ユーザー要望 → システム分析 → QA.txt追加 → 次回実行時に自動適用
```

### 2. 違反からの学習
```
制約違反検出 → パターン分析 → ルール抽出 → QA.txt記録 → 再発防止
```

### 3. 自動改善サイクル
```
実行 → 統計収集 → 改善提案 → ルール更新 → 次回実行で改善
```

## 📋 QA.txtの構造と管理

### セクション構成
1. **🔴 未回答の質問**: 対応が必要な新規質問
2. **✅ 解決済みの質問**: 回答済みの履歴（最新10件）
3. **📌 恒久的ルール**: システムが常に参照するルール
4. **📦 アーカイブ**: 古い情報（30日以上経過）

### 新しいルールの記録例
```markdown
### 🔑 空きスロット埋め時の交流学級同期ルール（2025-06-21追加）
**重要：空きスロットを埋める際は交流学級の同期を必ず維持する**
- 手動埋めスクリプトや自動埋め機能を使用する際、交流学級（6組・7組）の同期を必ず考慮する
- 交流学級の空きスロットを埋める際は、必ず親学級と同じ科目を配置する
- 親学級の空きスロットを埋める際は、交流学級も同時に同じ科目で埋める
```

## 🚀 今後の改善方針

### 1. 自動化の推進
- ユーザーの指摘を待たずに問題を検出・修正
- 実行ごとの学習により精度向上
- 新しいパターンの自動発見

### 2. ルールの優先度管理
- 競合するルールの自動調整
- 状況に応じた柔軟な適用
- 優先度の動的変更

### 3. フィードバックループの短縮
- リアルタイムでの違反検出
- 即座の修正提案
- ワンクリックでのルール適用

## 💡 ベストプラクティス

### 1. ルール記録時の注意点
- 具体的で実行可能な形式で記述
- 例外条件も明記
- 適用範囲を明確化

### 2. 違反対応の手順
1. 違反内容を詳細に分析
2. 根本原因を特定
3. 汎用的なルールとして定式化
4. QA.txtに記録
5. 次回実行で自動適用を確認

### 3. 継続的な監視
- 毎回の実行結果を確認
- 新しいパターンの違反に注目
- 改善の効果を測定

## 🔧 トラブルシューティング

### Q: 新しいルールが適用されない
A: 以下を確認してください：
1. QA.txtの恒久的ルールセクションに正しく記載されているか
2. ルールの形式が実行可能な形になっているか
3. システムの再起動が必要な場合があります

### Q: 交流学級同期が機能しない
A: 交流学級マッピングが正しいか確認：
- 1年6組 ← 1年1組
- 1年7組 ← 1年2組
- 2年6組 ← 2年3組
- 2年7組 ← 2年2組
- 3年6組 ← 3年3組
- 3年7組 ← 3年2組

### Q: 違反が減らない
A: 統計情報を確認し、パターンを分析：
```bash
python3 scripts/analysis/check_violations.py
```

## 📈 効果測定

### 成功指標
1. **制約違反数の減少**: 実行ごとに違反が減少
2. **空きスロット数の減少**: 完全な時間割に近づく
3. **実行時間の短縮**: 効率的なルール適用
4. **ユーザー介入の減少**: 自動化による手間削減

### 改善の可視化
- 実行ログの統計情報を確認
- 違反タイプ別の推移を追跡
- 学習したルールの適用率を測定

## 🎓 まとめ

このQandA継続的改善システムにより、時間割生成システムは使用するたびに賢くなります。ユーザーのフィードバックは貴重な学習データとなり、システムの品質向上に直接貢献します。

**重要な原則**:
1. すべてのルールはQA.txtに記録
2. 一度学習したルールは永続的に適用
3. 継続的な改善により品質向上

この仕組みにより、最終的には人間の介入を最小限に抑えた、高品質な時間割の自動生成が実現されます。