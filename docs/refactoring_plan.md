# 時間割生成システム リファクタリング計画

## 現状分析（2025年6月15日）

### 1. 主要な問題点

#### 1.1 重複コード
- `advanced_csp_schedule_generator.py` (31KB) と `advanced_csp_schedule_generator_refactored.py` (3KB)
- 複数のCSP関連ファイルが存在し、機能が重複

#### 1.2 不要なファイル
- バックアップファイル: `data/output/output_original_backup.csv`
- 一時的な修正スクリプト: `direct_fix_gym.py`, `fix_gym_properly.py`, etc.

#### 1.3 アーキテクチャの課題
- 制約システムが複雑で、一部の制約が正しく動作しない
- エラーハンドリングが不十分
- ロギングが過剰で、重要な情報が埋もれやすい

### 2. リファクタリング方針

#### フェーズ1: クリーンアップ（優先度: 高）
1. 不要なファイルの削除
2. 重複コードの統合
3. 一時的な修正スクリプトの整理

#### フェーズ2: アーキテクチャ改善（優先度: 高）
1. CSPアルゴリズムの統一
2. 制約システムの簡素化
3. エラーハンドリングの改善

#### フェーズ3: 品質向上（優先度: 中）
1. 型ヒントの追加
2. ドキュメントの更新
3. ロギングの最適化

#### フェーズ4: テスト追加（優先度: 低）
1. ユニットテストの追加
2. 統合テストの改善

## 実行計画

### ステップ1: 不要ファイルの削除
```bash
# バックアップファイル
rm data/output/output_original_backup.csv

# 一時的な修正スクリプト
rm direct_fix_gym.py
rm fix_gym_properly.py
rm fix_gym_violations.py
rm fix_daily_duplicates.py
rm fix_csv_duplicates.py
```

### ステップ2: CSPアルゴリズムの統合
- `advanced_csp_schedule_generator.py` を削除
- `advanced_csp_schedule_generator_refactored.py` を改善して一本化

### ステップ3: 制約システムの簡素化
- 重複している制約をマージ
- 制約の優先度を再評価
- 不要な制約を削除

### ステップ4: scripts/ディレクトリの整理
- fixes/: 一時的な修正スクリプトを削除または統合
- analysis/: 分析スクリプトを整理
- utilities/: ユーティリティを統合

## 期待される成果

1. **コードベースの削減**: 約30-40%のコード削減
2. **保守性の向上**: 重複コードの排除により保守が容易に
3. **パフォーマンス向上**: 不要な処理の削除により高速化
4. **理解しやすさ**: シンプルな構造により新規開発者も理解しやすく

## リスクと対策

- **リスク**: 動作中のシステムを壊す可能性
- **対策**: 段階的にリファクタリングを実行し、各段階でテストを実施

## タイムライン

- フェーズ1: 即時実行可能
- フェーズ2: 1-2時間
- フェーズ3: 1時間
- フェーズ4: 2-3時間（後日実施可）