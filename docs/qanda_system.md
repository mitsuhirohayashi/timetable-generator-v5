# QandAシステム - 自己学習機能

## 概要

QandAシステムは、時間割生成システムが実行時に遭遇した問題や不明な点について質問を生成し、ユーザーの回答から学習する自己改善機能です。これにより、システムは実行するたびに賢くなり、より良い時間割を生成できるようになります。

## 仕組み

### 1. 自動質問生成

システムは以下の状況で自動的に質問を生成します：

- **教師重複エラー**: 一人の教師が同時に複数クラスを担当する必要がある場合
- **制約違反**: 各種制約（日内重複、体育館使用、自立活動など）に違反した場合
- **空きコマ**: クラスに空きコマが多数発生した場合
- **時数不足**: 科目の授業時数が標準時数と異なる場合

### 2. 質問の記録

生成された質問は `QandA/QA.txt` ファイルの最上部に自動的に追加されます：

```
[2025-06-17 14:30:15]
Q: 井上先生が火曜5限に2-1, 2-2, 2-3の3クラスで数学を同時に教えることはできませんが、どのように対処すべきですか？
   Context: 違反パターン: 教師の同時複数クラス担当
A: [回答をここに追加]
```

### 3. ユーザーによる回答

ユーザーは `QandA/QA.txt` を開いて、「[回答をここに追加]」の部分に回答を記入します：

```
A: 井上先生の担当を2年1組と2年2組のみとし、2年3組は別の数学教師（例：林田先生）が担当するように変更してください。
```

### 4. システムの学習

次回実行時、システムは回答済みの質問を読み取り、以下のように活用します：

- 回答内容をルールとして解釈
- 必要に応じてCLAUDE.mdや設定ファイルに反映
- 同様の問題を回避するよう制約やアルゴリズムを調整

## 使い方

### 実行前の確認

時間割生成を実行すると、システムは自動的に以下を行います：

1. **未回答質問のチェック**: 未回答の質問がある場合は警告を表示
2. **学習済みルールの表示**: 過去の回答から学習したルールを表示

```bash
━━━ 未回答の質問があります ━━━
QandA/QA.txtに3件の未回答質問があります。
より良い時間割を生成するために、回答をお願いします。

[2025-06-17 14:30:15]
Q: 井上先生が火曜5限に2-1, 2-2, 2-3の3クラスで数学を同時に教えることはできませんが、どのように対処すべきですか？
   Context: 違反パターン: 教師の同時複数クラス担当
```

### 実行後の分析

時間割生成後、制約違反がある場合：

1. **違反分析**: 違反をパターン別に分析
2. **質問生成**: 解決方法が不明な問題について質問を生成
3. **改善提案**: 可能な解決策を提示

```bash
━━━ 制約違反の分析 ━━━
総違反数: 42件

違反タイプ別:
  • teacher_conflict: 15件
  • daily_duplicate: 10件
  • jiritsu_activity: 8件
  • gym_usage: 9件

システムが2個の質問を生成しました。
QandA/QA.txtに追加されました。
```

## QA.txtの構造

```
# 時間割生成システム - 質問と回答集 (QA.txt)

---

## 【新規質問追加欄】 - システムが自動的に質問を追加します

### システムからの質問（最新の質問が上に表示されます）

[システムが生成した質問がここに追加されます]

### ユーザーからの新しい要件・質問

Q: [ユーザーが手動で追加する質問]
A: [回答]

---

## 1. 教師配置に関する質問
[既存のQ&A...]
```

## ベストプラクティス

### 良い回答の例

✅ **具体的で実行可能な回答**:
```
Q: 3年6組の自立活動が配置できない問題をどのように解決すべきですか？
A: 3年3組の時間割を調整し、月曜3限と木曜2限に数学を配置してください。これにより3年6組が自立活動を行える時間が確保できます。
```

✅ **ルールを明確にする回答**:
```
Q: 体育館使用の重複をどのように防ぐべきですか？
A: 各学年の体育は異なる曜日に集中させてください。例：1年生は月水、2年生は火木、3年生は水金など。
```

### 避けるべき回答

❌ **曖昧な回答**:
```
A: 適当に調整してください。
```

❌ **実現不可能な回答**:
```
A: 教師を増やしてください。（システムは教師数を変更できません）
```

## 高度な使い方

### プログラマー向け

QandAシステムは以下のAPIを提供します：

```python
from src.application.services.qanda_service import QandAService

# サービスの初期化
qanda = QandAService()

# 質問の追加
qanda.add_system_question(
    "井上先生の重複問題をどう解決すべきですか？",
    context="火曜5限に3クラス同時"
)

# 未回答質問の取得
unanswered = qanda.get_unanswered_questions()

# 学習したルールの適用
rules = qanda.apply_learned_rules()
```

### カスタマイズ

`src/application/services/constraint_violation_analyzer.py` を編集することで、質問生成のパターンをカスタマイズできます。

## トラブルシューティング

### Q: 質問が生成されない

A: 制約違反が少ない場合や、パターンとして認識されない場合は質問が生成されません。`--verbose` オプションで詳細ログを確認してください。

### Q: 回答が反映されない

A: 回答は次回実行時に読み込まれます。また、回答が「[回答をここに追加]」を完全に置き換えているか確認してください。

### Q: 質問が重複する

A: システムは同じ質問を重複して追加しないよう設計されていますが、文言が微妙に異なる場合は別の質問として扱われます。