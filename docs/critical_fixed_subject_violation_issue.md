# 固定科目の不正変更問題 - 根本原因と防止策

## 概要
システムが月曜6限のYTを勝手に欠に変更する重大な問題が発生しました。これは「固定科目を変更しない」という基本ルールに違反しています。

## 発見された問題

### 1. 固定科目の不正変更（14件）
```
1年1組 月曜6限: YT → 欠 (変更禁止)
1年2組 月曜6限: YT → 欠 (変更禁止)
1年3組 月曜6限: YT → 欠 (変更禁止)
1年5組 月曜6限: YT → 欠 (変更禁止)
1年6組 月曜6限: YT → 欠 (変更禁止)
1年7組 月曜6限: YT → 欠 (変更禁止)
2年1組 月曜6限: YT → 欠 (変更禁止)
2年2組 月曜6限: YT → 欠 (変更禁止)
2年3組 月曜6限: YT → 欠 (変更禁止)
2年5組 月曜6限: YT → 欠 (変更禁止)
2年6組 月曜6限: YT → 欠 (変更禁止)
2年7組 月曜6限: YT → 欠 (変更禁止)
3年6組 月曜6限: YT → 欠 (変更禁止)
3年7組 月曜6限: YT → 欠 (変更禁止)
```

## 根本原因

### 1. MondaySixthPeriodConstraint のデフォルトルール
```python
# src/domain/constraints/monday_sixth_period_constraint.py
# 行85-86:
# それ以外は欠課
expected_subject = "欠"
```

このコードは、1・2年生の月曜6限を強制的に「欠」にしようとします。
しかし、input.csvでは全クラスが月曜6限は「YT」となっています。

### 2. fix_monday_6th_period.py スクリプト
このスクリプトは月曜6限をYTから欠に変更する処理を行います。
これは基本ルール違反です。

## 固定科目変更の禁止ルール

**絶対に変更してはいけない科目：**
- 欠（欠課）
- YT（特別活動）
- 学、学活（学級活動）
- 総、総合（総合的な学習の時間）
- 道、道徳（道徳）
- 学総（学年総合）
- 行、行事（行事）
- テスト（定期テスト）
- 技家（技術・家庭科合併テスト）

**重要原則：**
1. input.csvに記載されている固定科目は絶対に変更しない
2. システムがデフォルトルールで上書きしてはいけない
3. QA.txtやCLAUDE.mdのルールよりもinput.csvが優先される

## 防止策

### 1. 制約の修正
MondaySixthPeriodConstraintを以下のように修正：
- デフォルトで「欠」を強制するのではなく、input.csvの内容を尊重
- 既に配置されている固定科目は変更しない

### 2. 修正スクリプトの削除・無効化
- fix_monday_6th_period.py は使用禁止
- 固定科目を変更する全てのスクリプトを確認

### 3. 固定科目保護の強化
- FixedSubjectProtectionPolicyの徹底
- 配置前に既存の固定科目をチェック

### 4. ルールの明文化
CLAUDE.mdに以下を追加：
```
## ⚠️ 最重要ルール - 固定科目の絶対保護

**input.csvの固定科目は絶対に変更禁止**
- システムのデフォルトルールよりもinput.csvが優先
- 月曜6限がYTならYTのまま（欠に変更しない）
- 制約違反として報告するのは可だが、勝手に修正しない
```

## テスト期間との混同に注意

このケースはテスト期間ではありません：
- テスト期間はFollow-up.csvに明記される
- テスト期間でない限り、通常の運用ルールに従う
- 月曜6限のYTは通常の特別活動時間

## 推奨アクション

1. **即時対応**
   - output.csvを手動で修正し、月曜6限をYTに戻す
   - MondaySixthPeriodConstraintのデフォルトルールを削除

2. **システム改修**
   - 固定科目の変更を完全にブロックする機能を実装
   - input.csvの内容を最優先とするロジックに変更

3. **監査機能**
   - 固定科目の変更を検出する監査ツールを作成
   - 生成後に必ず差分チェックを実行

## まとめ

この問題は「システムが賢すぎて、勝手にルールを適用してしまった」ケースです。
input.csvは人間が慎重に作成した基本時間割であり、システムはそれを尊重し、
補完することが役割です。置き換えることではありません。