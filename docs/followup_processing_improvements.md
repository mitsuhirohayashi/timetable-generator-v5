# Follow-up指示処理の改善

## 概要

Follow-up.csvの自然言語指示をより確実に処理し、特にテスト期間の保護を自動化するシステムを実装しました。

## 実装内容

### 1. 拡張Follow-upパーサー (`enhanced_followup_parser.py`)

自然言語処理機能を強化し、以下の指示を自動検出・処理します：

- **テスト期間指示**
  - 「○○校時はテストなので時間割の変更をしないでください」
  - 検出されたテスト期間は自動的に保護スロットとして登録

- **教員不在情報**
  - 教員名、曜日、時限、理由を自動抽出
  - 「終日」「午前」「午後」などの表現にも対応

- **会議情報**
  - 企画、生指、特会、HFなどの会議時間を検出

### 2. Follow-upプロセッサー (`followup_processor.py`)

検出された指示をスケジュールに適用する処理を実装：

- **テスト期間保護**
  - テスト期間のスロットに「行」（行事）を自動設定
  - 5組以外の全クラスが対象
  - 保護されたスロットはロック（変更不可）

- **保護スロット管理**
  - 保護対象のスロットを効率的に管理
  - スケジュール生成時に保護状態をチェック

### 3. テスト期間除外制約 (`test_period_exclusion.py`)

テスト期間中の通常授業配置を防ぐ制約を実装：

- テスト期間は「行」以外の科目を配置不可
- 制約違反時は警告を出力

### 4. スケジュール生成フローへの統合

`generate_schedule.py`に以下の処理を追加：

1. Follow-up.csvの解析（テスト期間検出を含む）
2. 初期スケジュールへのテスト期間適用
3. 保護スロットのマーキング
4. 制約システムへの登録

## 使用方法

### 1. Follow-up.csvでの指定

```
月曜日：
１・２・３校時はテストなので時間割の変更をしないでください。

火曜日：
１・２・３校時はテストなので時間割の変更をしないでください。

水曜日：
１・２校時はテストなので時間割の変更をしないでください。
```

### 2. スケジュール生成

通常通りスケジュールを生成するだけで、テスト期間が自動的に保護されます：

```bash
python3 main.py generate
```

### 3. 検証

テスト期間保護の動作確認：

```bash
python3 scripts/analysis/verify_test_period_protection.py
```

## 実装の詳細

### テスト期間検出パターン

以下のパターンでテスト期間を検出します：

1. `(\d+)校時.*テストなので時間割の変更をしないでください`
2. `テストなので.*(\d+)校時.*時間割の変更をしない`
3. `(\d+)校時.*はテスト`
4. `テスト実施.*(\d+)校時`

### 保護対象クラス

- 1年1組〜4組、6組、7組
- 2年1組〜4組、6組、7組
- 3年1組〜4組、6組、7組
- **5組は対象外**（特別支援学級のため）

### 制約の優先度

- テスト期間除外制約: HIGH
- 教員不在制約: CRITICAL
- 会議制約: CRITICAL

## テスト結果

現在のFollow-up.csvでの検証結果：

- 月曜日: 1,2,3時限（54スロット保護）✓
- 火曜日: 1,2,3時限（54スロット保護）✓
- 水曜日: 1,2時限（36スロット保護）✓

合計144スロットが正しく保護されています。

## 今後の拡張

1. **他の保護指示への対応**
   - 「○○の授業は変更しないでください」
   - 「○○先生の授業を優先してください」

2. **より柔軟な表現への対応**
   - 「テスト期間」「考査期間」などの同義語
   - 時限表記のバリエーション（「1限目」「第1校時」など）

3. **保護状態の可視化**
   - 出力されたスケジュールで保護スロットを明示
   - 保護理由の記録と表示